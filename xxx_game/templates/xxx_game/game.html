<!DOCTYPE html>
<html>
<head>
    <title>Game</title>
    {% load static %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/game.css' %}">

    <script src="{% static 'js/game.js' %}"></script>
    <script src="{% static 'js/base.js' %}"></script>
    
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
</head>
<body onload="init()" class="main-container">
    
    <div class="upload-avatar">
        <div class="upload-avatar-content">
            <div>
                <span class="upload-avatar-close">X</span>
            </div>
            <div class="upload-avatar-input">
                {% if logged_in %}
                <form action="/upload-avatar/" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    Upload:
                    <input type="file" name="avatar">
                    <input type="submit" value="Upload">
                </form>
                {% else %}
                <span>only logged user can upload avatar.</span>
                {% endif %}
            
            </div>
        </div>
    </div>

    <div class="left-container">
        <input type="text" id="game-id" name="game_id" hidden value="{{game_id}}"/>
        <div>
            <img src="{% static 'images/logo.png' %}" class="logo">
        </div>
        <div class="chat-button" id="go-chat">
            <p>CHAT</p>
            <img style="width:100px;height:100px;" src="{% static 'images/chat.png' %}">
        </div>
        <button onclick="leave_game()" class="button_"> home </button>
        <!-- <button onclick="window.location.href='/'" class="button_">go to login </button>
        <button onclick="window.location.href='/logout'" class="button_">logout</button> -->
    </div>

    <div id="content" class="center-container">
        <div class="question-answer">
            <div class="question">
                <label>What days of the week does cse 312 meet?</label>
            </div>
            <div class="answer">
                <div>
                    Option1
                </div>
                <div>
                    Option2
                </div>
                <div>
                    Option3
                </div>
                <div>
                    Option4
                </div>
            </div>
        </div>
    </div>
    <div class="right-container">
        <div>
            <img src="{% static avatar_url %}" class="avatar">
            <h1>{{username}}</h1>
        </div>

        <input type="text" id="game-id" name="game_id" hidden value="{{game_id}}"/>

        <!-- <button onclick="leave_game()"> leave_game </button> -->
        <div>
            <p>Players: </p>
            <div id="players">
                <p><img src="{% static avatar_url %}" class="avatar-small"> Player1</p>
                <p><img src="{% static avatar_url %}" class="avatar-small">Player2</p>
                <p><img src="{% static avatar_url %}" class="avatar-small">Player3</p>
                <p><img src="{% static avatar_url %}" class="avatar-small">Player4</p>
            </div>
        </div>
        <script>
            const chatSocket = new WebSocket(
                'ws://'
                + window.location.host
                + '/ws/game/'
            );
            
            // document.querySelector('form').addEventListener('submit', function(event) {
            // event.preventDefault();
    
            // const formData = new FormData(this);
            // const data = {};
    
            // formData.forEach((value, key) => {
            //     data[key] = value;
            // });
    
            // console.log(JSON.stringify(data))
            // chatSocket.send(JSON.stringify(data));
            // document.querySelector('#chatInput').value = "";
            // });
    
            chatSocket.onmessage = function(e) {
                // const data = JSON.parse(e.data);
                // console.log(`data: ${e.data}`)
                // // document.querySelector('#chat-log').value += (data.message + '\n');
                // document.querySelector('#chat-log').innerHTML += (
                //     `<div class="post">
                //     </div>`
                // );

                let players = document.getElementById("players");
                players.innerHTML = "";
                JSON.parse(e.data).forEach(function(item){
                    players.innerHTML += "<p><img src='/static/"+item['avatar']+"' class='avatar-small'>"+item['username']+"</p>"; 
                });
            };
    
            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };
    
        </script>
    </div>

</body>
</html>